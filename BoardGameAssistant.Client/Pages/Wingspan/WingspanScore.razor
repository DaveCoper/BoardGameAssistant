@page "/wingspan/{GameId:int}"
@using BoardGameAssistant.Client.Components
@using BoardGameAssistant.Client.Model
@using BoardGameAssistant.ServiceContracts.Wingspan
@using BoardGameAssistant.ServiceContracts.Wingspan.Dto
@using Microsoft.Extensions.Localization

@inject IStringLocalizer<BoardGameAssistant.Client.Pages.Wingspan.WingspanScore> Localizer

<PageTitle>@Localizer["ScreenTitle"]</PageTitle>
<h1>@Localizer["ScreenHeader"]</h1>

@if (game is null)
{
    <LoadingComponent />
}
else
{
    <MudDataGrid Items="this.game.PlayerScores" ReadOnly=false EditMode="DataGridEditMode.Cell" Elevation="0">
        <Columns>
            <PropertyColumn Property="@(x => x.PlayerName)" Title="@Localizer["GridTitle_PlayerName"]">
            </PropertyColumn>
            <PropertyColumn Property="@(x => x.PointsForBirds)" Title="@Localizer["GridTitle_Birds"]">
                <EditTemplate>
                    <NumberEditor @bind-Value="context.Item.PointsForBirds" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@(x => x.TuckedCards)" Title="@Localizer["GridTitle_Food"]">
                <EditTemplate>
                    <NumberEditor @bind-Value="context.Item.TuckedCards" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@(x => x.Eggs)" Title="@Localizer["GridTitle_Eggs"]">
                <EditTemplate>
                    <NumberEditor @bind-Value="context.Item.Eggs" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@(x => x.PointsForBirds)" Title="@Localizer["GridTitle_TuckedCards"]">
                <EditTemplate>
                    <NumberEditor @bind-Value="context.Item.PointsForBirds" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@(x => x.PointsForObjectives)" Title="@Localizer["GridTitle_BonusCards"]">
                <EditTemplate>
                    <NumberEditor @bind-Value="context.Item.PointsForObjectives" />
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="@(x => x.EndOfRoundGoals)" Title="@Localizer["GridTitle_EndOfRoundGoals"]">
                <EditTemplate>
                    <NumberEditor @bind-Value="context.Item.EndOfRoundGoals" />
                </EditTemplate>
            </PropertyColumn>
            @if (game.HasOceaniaExpansion)
            {
                <PropertyColumn Property="@(x => x.NectarOnRow1)" Title="@Localizer["GridTitle_NectarOnRow1"]">
                    <EditTemplate>
                        <NumberEditor @bind-Value="context.Item.NectarOnRow1" />
                    </EditTemplate>
                </PropertyColumn>

                <PropertyColumn Property="@(x => x.NectarOnRow2)" Title="@Localizer["GridTitle_NectarOnRow2"]">
                    <EditTemplate>
                        <NumberEditor @bind-Value="context.Item.NectarOnRow2" />
                    </EditTemplate>
                </PropertyColumn>

                <PropertyColumn Property="@(x => x.NectarOnRow3)" Title="@Localizer["GridTitle_NectarOnRow3"]">
                    <EditTemplate>
                        <NumberEditor @bind-Value="context.Item.NectarOnRow3" />
                    </EditTemplate>
                </PropertyColumn>
            }

            <TemplateColumn Title="@Localizer["GridTitle_TotalScore"]" Editable=false>
                <CellTemplate>
                    <MudText>@(CalculateScore(context.Item))</MudText>
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Editable=false>
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@code {

    [Inject]
    public IWingspanGameService GameService { get; set; } = null!;

    [Inject]
    public Services.TitleMenuService TitleMenuService { get; set; } = null!;

    [Parameter]
    public int GameId { get; set; }

    private WingspanGame? game;

    protected override async Task OnInitializedAsync()
    {
        var menuOption = new MenuOption
        {
            Icon = Icons.Material.Filled.Add,
            Title = Localizer["AddPlayer"],
            Color = Color.Inherit,
            Command = this.AddPlayer
        };

        TitleMenuService.Options = [menuOption];


        var tmpGame = await this.GameService.GetGameAsync(GameId);
        if (tmpGame.PlayerScores is null)
            tmpGame.PlayerScores = [];

        game = tmpGame;

        await base.OnInitializedAsync();
    }

    private void AddPlayer()
    {
        if (game is not null)
        {
            game.PlayerScores.Add(new WingspanPlayerScore
            {
                PlayerName = $"Player {game.PlayerScores.Count + 1}"
            });

            this.StateHasChanged();
        }
    }

    private int CalculateScore(WingspanPlayerScore score)
    {
        return
            score.Eggs +
            score.TuckedCards +
            score.PointsForObjectives +
            score.PointsForBirds + 
            score.EndOfRoundGoals;
    }
}
